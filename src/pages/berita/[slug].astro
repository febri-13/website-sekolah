---
import Layout from '../../layouts/Layout.astro';
import { sanityClient, urlFor, formatDate } from '../../lib/sanity';

interface Berita {
  _id: string;
  title: string;
  slug: { current: string };
  publishedAt: string;
  excerpt: string;
  content: any[];
  featuredImage?: any;
  category: string;
  gradientFrom: string;
  gradientTo: string;
}

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(
    `*[_type == "berita" && isPublished == true] {
      "slug": slug.current
    }`
  );
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

const berita = await sanityClient.fetch<Berita>(
  `*[_type == "berita" && slug.current == $slug && isPublished == true][0] {
    _id, title, slug, publishedAt, excerpt, content, featuredImage, category, gradientFrom, gradientTo
  }`,
  { slug }
);

if (!berita) return Astro.redirect('/berita');

const relatedBerita = await sanityClient.fetch<Berita[]>(
  `*[_type == "berita" && category == $category && slug.current != $slug && isPublished == true] | order(publishedAt desc) [0...3] {
    _id, title, slug, publishedAt, excerpt, featuredImage, category, gradientFrom, gradientTo
  }`,
  { category: berita.category, slug }
);

const icons: Record<string, string> = {
  akademik: 'ğŸ“š', prestasi: 'ğŸ†', kegiatan: 'ğŸŒ', pengumuman: 'ğŸ“¢'
};

function renderContent(content: any[]): string {
  if (!content) return '';
  return content.map((block: any) => {
    if (block._type === 'block') {
      // Handle text dengan marks (bold, italic, etc)
      const children = block.children?.map((child: any) => {
        let text = child.text || '';
        
        // Handle marks (bold, italic, underline, etc)
        if (child.marks && child.marks.length > 0) {
          child.marks.forEach((mark: string) => {
            if (mark === 'strong') text = `<strong>${text}</strong>`;
            if (mark === 'em') text = `<em>${text}</em>`;
            if (mark === 'underline') text = `<u>${text}</u>`;
            if (mark === 'code') text = `<code class="bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-sm">${text}</code>`;
          });
        }
        
        return text;
      }).join('') || '';
      
      // Handle different block styles
      if (block.style === 'h1') return `<h1 class="text-3xl font-bold mb-4 mt-8 text-gray-900 dark:text-white">${children}</h1>`;
      if (block.style === 'h2') return `<h2 class="text-2xl font-bold mb-3 mt-6 text-gray-900 dark:text-white">${children}</h2>`;
      if (block.style === 'h3') return `<h3 class="text-xl font-bold mb-2 mt-4 text-gray-900 dark:text-white">${children}</h3>`;
      if (block.style === 'blockquote') return `<blockquote class="border-l-4 border-primary-500 pl-4 italic my-6 text-gray-600 dark:text-gray-400">${children}</blockquote>`;
      
      // Handle lists
      if (block.listItem === 'bullet') return `<li class="ml-6 mb-2 text-gray-700 dark:text-gray-300">${children}</li>`;
      if (block.listItem === 'number') return `<li class="ml-6 mb-2 text-gray-700 dark:text-gray-300">${children}</li>`;
      
      // Default paragraph - PENTING: mb-6 untuk spacing antar paragraph!
      return `<p class="mb-6 text-gray-700 dark:text-gray-300 leading-relaxed text-justify">${children}</p>`;
    }
    
    if (block._type === 'image' && block.asset) {
      const img = urlFor(block).width(800).url();
      const caption = block.caption ? `<figcaption class="text-sm text-center text-gray-600 dark:text-gray-400 mt-2 italic">${block.caption}</figcaption>` : '';
      return `<figure class="my-8"><img src="${img}" alt="${block.alt || ''}" class="rounded-lg w-full shadow-lg" />${caption}</figure>`;
    }
    
    return '';
  }).join('');
}

const contentHtml = renderContent(berita.content || []);
const hasHero = berita.featuredImage?.asset;
const heroUrl = hasHero ? urlFor(berita.featuredImage).width(1200).height(600).url() : '';
---

<Layout title={`${berita.title} - ABBS Surakarta`}>
  <div>
    <section class="relative h-96 overflow-hidden">
      {hasHero ? (
        <img src={heroUrl} alt={berita.title} class="absolute inset-0 w-full h-full object-cover" />
      ) : (
        <div class={`absolute inset-0 bg-gradient-to-br ${berita.gradientFrom} ${berita.gradientTo}`}></div>
      )}
      <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/30 to-transparent"></div>
    </section>

    <article class="max-w-4xl mx-auto px-4 -mt-32 relative z-10">
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 md:p-12 shadow-2xl mb-8">
        <nav class="text-sm mb-6">
          <a href="/" class="text-primary-600 dark:text-primary-400 hover:underline">Beranda</a>
          <span class="mx-2 text-gray-400">/</span>
          <a href="/berita" class="text-primary-600 dark:text-primary-400 hover:underline">Berita</a>
          <span class="mx-2 text-gray-400">/</span>
          <span class="text-gray-600 dark:text-gray-400">{berita.title}</span>
        </nav>

        <div class="flex items-center gap-4 mb-6">
          <span class="px-4 py-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full font-semibold text-sm">
            {icons[berita.category]} {berita.category}
          </span>
          <span class="text-gray-500 dark:text-gray-400 text-sm">
            ğŸ“… {formatDate(berita.publishedAt)}
          </span>
        </div>

        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-6 leading-tight">
          {berita.title}
        </h1>

        <p class="text-xl text-gray-600 dark:text-gray-400 leading-relaxed mb-8 border-l-4 border-primary-500 pl-6 italic">
          {berita.excerpt}
        </p>

        <div class="border-t border-gray-200 dark:border-gray-700 mb-8"></div>

        <div class="article-content prose prose-lg max-w-none">
          <Fragment set:html={contentHtml} />
        </div>

        <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Bagikan Artikel</h3>
          <div class="flex gap-3">
            <a href={`https://facebook.com/sharer/sharer.php?u=${Astro.url.href}`} target="_blank" rel="noopener" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center transition">ğŸ“˜</a>
            <a href={`https://twitter.com/intent/tweet?url=${Astro.url.href}&text=${berita.title}`} target="_blank" rel="noopener" class="w-12 h-12 bg-sky-500 hover:bg-sky-600 text-white rounded-full flex items-center justify-center transition">ğŸ¦</a>
            <a href={`https://wa.me/?text=${berita.title} ${Astro.url.href}`} target="_blank" rel="noopener" class="w-12 h-12 bg-green-600 hover:bg-green-700 text-white rounded-full flex items-center justify-center transition">ğŸ’¬</a>
          </div>
        </div>
      </div>

      {relatedBerita.length > 0 && (
        <section class="mb-16">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">Berita Terkait</h2>
          <div class="grid md:grid-cols-3 gap-6">
            {relatedBerita.map((r) => {
              const hasImg = r.featuredImage?.asset;
              const imgUrl = hasImg ? urlFor(r.featuredImage).width(400).height(250).url() : '';
              return (
                <article class="bg-white dark:bg-gray-800 rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition">
                  {hasImg ? (
                    <img src={imgUrl} alt={r.title} class="h-40 w-full object-cover" />
                  ) : (
                    <div class={`h-40 bg-gradient-to-br ${r.gradientFrom} ${r.gradientTo} flex items-center justify-center text-4xl`}>
                      {icons[r.category] || 'ğŸ“–'}
                    </div>
                  )}
                  <div class="p-4">
                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">{formatDate(r.publishedAt)}</div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2 line-clamp-2">{r.title}</h3>
                    <a href={`/berita/${r.slug.current}`} class="text-primary-600 dark:text-primary-400 font-semibold hover:underline text-sm">Selengkapnya â†’</a>
                  </div>
                </article>
              );
            })}
          </div>
        </section>
      )}

      <div class="text-center mb-16">
        <a href="/berita" class="inline-flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-8 py-4 rounded-lg font-bold transition shadow-lg">â† Kembali</a>
      </div>
    </article>
  </div>
</Layout>

<style>
  .prose { @apply text-gray-700 dark:text-gray-300; }
  .prose h1, .prose h2, .prose h3 { @apply text-gray-900 dark:text-white; }
  .prose a { @apply text-primary-600 dark:text-primary-400 hover:underline; }
  
  /* Article content spacing */
  .article-content p:last-child { @apply mb-0; }
  .article-content ul, .article-content ol { @apply list-disc ml-6 mb-6 space-y-2; }
  .article-content ol { @apply list-decimal; }
  .article-content strong { @apply font-bold text-gray-900 dark:text-white; }
  .article-content em { @apply italic; }
  .article-content code { @apply font-mono text-sm; }
</style>